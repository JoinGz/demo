<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    .centerBox {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      height: 100vh;
      padding:0  20vh;
      align-content: center;
    }
    #file,#list{
      width: 100%;
    }
  </style>
</head>

<body class="centerBox">
  <input type="file" id="file">
  <!-- <form method="post" action="http://127.0.0.1:3001/upload">
    <input name="name" type="file" />
    <input type="submit" value="以POST提交" />
  </form> -->
  <ul id="list">

  </ul>
</body>
<script>
  const SLICE_NUM = 100; //KB
  let selectFile;
  let file = document.querySelector('#file')
  let ul = document.querySelector('#list')
  let li = document.createElement('li')
  file.addEventListener('change', select)

  function select(e) {
    let file = e.target.files[0]
    Promise.all(sendFileChunk(getSliceFile(file))).then(rs => {
      ajax({
        url: 'http://127.0.0.1:3001/merge', data: JSON.stringify({
          'filename': selectFile.name
        }),
        headers: {
          "content-type": "application/json"
        }
      })
    })
  }

  function getSliceFile(file) {
    selectFile = file
    let fileSize = file.size
    if (SLICE_NUM < fileSize) {
      let chunkSize = (file.size / 1024 / SLICE_NUM).toFixed(0)
      let chunkEachSize = (file.size / chunkSize).toFixed(0)
      let ChunkList = []
      for (let i = 1; i <= chunkSize; i++) {
        ChunkList.push({
          chunk: file.slice((i - 1) * chunkEachSize, i * chunkEachSize),
          hash: file.name + i,
        })
      }
      console.log(ChunkList);

      return ChunkList
    }
  }

  function ajax({
    url,
    headers = {},
    data,
    onprogress = e => e
  }) {
    return new Promise((resolve, reject) => {
      let xhr = new XMLHttpRequest()
      xhr.open('post', url)
      Object.keys(headers).forEach(v => {
        xhr.setRequestHeader(v, headers[v])
      })
      // 在send之前
      xhr.upload.onprogress = onprogress
      xhr.send(data)
      xhr.onload = e => {
        resolve({
          data: e.target.response
        })
      }
    })
  }

  function sendFileChunk(ChunkList) {
    return ChunkList.map((v) => {
      let data = new FormData()
      data.append('chunk', v.chunk)
      data.append('hash', v.hash)
      data.append('filename', selectFile.name)
      return ajax({
        url: 'http://127.0.0.1:3001/upload',
        data,
        headers: {},
        onprogress: createProgress(v)
      })

    })
  }
  function createProgress (item) {
    return function (e) {
      if(item.li) {
        item.li.innerHTML = item.hash + ' ' + (( e.loaded /  e.total ) * 100).toFixed(2) + '%'
      } else {
        let lic = li.cloneNode()
        item.li = lic
        item.li.innerHTML = item.hash + ' ' + (( e.loaded /  e.total ) * 100).toFixed(2) + '%'
        ul.appendChild(item.li)
      }
    }
  }
</script>

</html>